<html>
<body>
    <embed type="application/x-node" id="plugin" />
    <script type="text/javascript">      
        window.NODE = document.getElementById("plugin");

        window.require = (function() {
          const START_LOAD = "(function() { var module = { exports: {} }, exports = module.exports;",
              END_LOAD = "; return module.exports;})()";

          function getBundledPath(file) {
            return chrome.extension.getURL(file);
          }

          var bundled = {
            "util": getBundledPath("node/util.js"),
            "http": getBundledPath("node/http2.js"),
            "assert": getBundledPath("node/assert.js"),
            "punycode": getBundledPath("node/punycode.js"),
            "buffer": getBundledPath("node/buffer.js"),
            "url": getBundledPath("node/url.js"),
            "freelist": getBundledPath("node/freelist.js"),
            "events": getBundledPath("node/events.js"),
            "crypto": getBundledPath("node/crypto.js"),
            "querystring": getBundledPath("node/querystring.js"),
            "stream": getBundledPath("node/stream.js"),
            "net": getBundledPath("node/net.js"),

            "ctio-faster": getBundledPath("websockets/ctio-faster.js"),
            "Constants": getBundledPath("websockets/Constants.js"),
            "Validation": getBundledPath("websockets/Validation.js"),
            "FastBufferList": getBundledPath("websockets/FastBufferList.js"),
            "utils": getBundledPath("websockets/utils.js"),
            "websocket": getBundledPath("websockets/websocket.js"),
            "WebSocketClient": getBundledPath("websockets/WebSocketClient.js"),
            "WebSocketConnection": getBundledPath("websockets/WebSocketConnection.js"),
            "WebSocketFrame": getBundledPath("websockets/WebSocketFrame.js"),
            "WebSocketRequest": getBundledPath("websockets/WebSocketRequest.js"),
            "WebSocketRouter": getBundledPath("websockets/WebSocketRouter.js"),
            "WebSocketRouterRequest": getBundledPath("websockets/WebSocketRouterRequest.js"),
            "WebSocketServer": getBundledPath("websockets/WebSocketServer.js")
          };
          var loaded = {};

          var stack = [];

          function require(libName) {
            var contents;
            if(loaded[libName]) {
              contents = loaded[libName];
            }
            else if(bundled[libName]) {
              var xhr = new XMLHttpRequest();
              xhr.open('GET', bundled[libName], false);
              xhr.send(null);
              contents = loaded[libName] = xhr.responseText;
            }
            if(contents) {
              return eval(START_LOAD + contents + END_LOAD);
            }
          };

          return require;
        })();
        
        var http = require("http");

        var server = http.createServer(function(request, response) {
          response.writeHead(200, {
            "content-type": "text/plain"
          });
          response.end("hello world");
        });

        server.listen(8899);

    </script>

</body>
</html>
